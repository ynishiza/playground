
\i ~/.psqlrc

\echo 'Loading custom psqlrc'

-- clear custom routines
CREATE OR REPLACE procedure clear_my_routines(namespace text DEFAULT 'public') AS $$
DECLARE
  builtin_namespaces constant text[] = ARRAY['pg_catalog', 'information_schema'];
  routine record;
  query text;
BEGIN
  RAISE INFO 'DROP routines for namespace %', namespace;
  FOR routine IN
      -- get routines defined by current user
      SELECT
        format('%I.%I', nspname, proname) as qualifiedname,
        *
      FROM pg_proc pro
      INNER JOIN pg_namespace n ON pro.pronamespace = n.oid
      WHERE
        -- note: omit builtins
        NOT n.nspname = ANY(builtin_namespaces)
        AND pro.proowner = to_regrole(current_user)::oid
        AND pro.proname <> 'clear_my_routines'
        -- note: exclude extension functions
        AND pro.probin IS NULL
  LOOP
      IF routine.nspname <> namespace THEN
        RAISE INFO 'Skipping %', routine.qualifiedname;
        CONTINUE;
      END IF;

      query := format(
        'DROP ROUTINE %s(%s)',
        routine.qualifiedname,
        pg_get_function_identity_arguments(routine.oid)
      );

      RAISE INFO '%', query;
      EXECUTE format(query);
  END LOOP;

  IF NOT FOUND THEN
    RAISE INFO 'No routines found';
  END IF;
END;
$$ LANGUAGE PLPGSQL;

call clear_my_routines();
